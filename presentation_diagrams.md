# Flink 스터디 발표용 시각 자료

## 1. Flink 클러스터 아키텍처 다이어그램

```
┌─────────────────────────────────────────────────────────────────┐
│                    Flink 클러스터 아키텍처                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐ │
│  │   JobManager    │    │   JobManager    │    │   JobManager    │ │
│  │   (마스터 노드)   │    │   (마스터 노드)   │    │   (마스터 노드)   │ │
│  │                 │    │                 │    │                 │ │
│  │ • Job 스케줄링   │    │ • Checkpoint    │    │ • 리소스 관리    │ │
│  │ • 리소스 관리    │    │   Coordinator   │    │ • 장애 감지      │ │
│  │ • 장애 감지      │    │ • JobGraph 배포 │    │ • 복구 조정      │ │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘ │
│           │                       │                       │         │
│           └───────────────────────┼───────────────────────┘         │
│                                   │                               │
│  ┌─────────────────────────────────┼─────────────────────────────────┐ │
│  │                    TaskManager (워커 노드)                        │ │
│  │                                                                 │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │ │
│  │  │   Slot 1    │  │   Slot 2    │  │   Slot 3    │            │ │
│  │  │             │  │             │  │             │            │ │
│  │  │ Source Task │  │ Process     │  │ Sink Task   │            │ │
│  │  │ (user1)     │  │ Task        │  │ (로그 출력)  │            │ │
│  │  │             │  │ (user1)     │  │             │            │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘            │ │
│  │                                                                 │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │ │
│  │  │   Slot 4    │  │   Slot 5    │  │   Slot 6    │            │ │
│  │  │             │  │             │  │             │            │ │
│  │  │ Source Task │  │ Process     │  │ Sink Task   │            │ │
│  │  │ (user2)     │  │ Task        │  │ (로그 출력)  │            │ │
│  │  │             │  │ (user2)     │  │             │            │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘            │ │
│  │                                                                 │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │ │
│  │  │   Slot 7    │  │   Slot 8    │  │   Slot 9    │            │ │
│  │  │             │  │             │  │             │            │ │
│  │  │ Source Task │  │ Process     │  │ Sink Task   │            │ │
│  │  │ (user3)     │  │ Task        │  │ (로그 출력)  │            │ │
│  │  │             │  │ (user3)     │  │             │            │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘            │ │
│  └─────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## 2. 스트림 처리 파이프라인 다이어그램

```
┌─────────────────────────────────────────────────────────────────┐
│                    실시간 스트림 처리 파이프라인                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐        │
│  │    Source   │    │    Source   │    │    Source   │        │
│  │   (user1)   │    │   (user2)   │    │   (user3)   │        │
│  │             │    │             │    │             │        │
│  │ • 5초마다    │    │ • 5초마다    │    │ • 5초마다    │        │
│  │   이벤트 생성 │    │   이벤트 생성 │    │   이벤트 생성 │        │
│  │ • 30% 확률   │    │ • 30% 확률   │    │ • 30% 확률   │        │
│  │   이상행동    │    │   이상행동    │    │   이상행동    │        │
│  └─────────────┘    └─────────────┘    └─────────────┘        │
│           │                   │                   │            │
│           └───────────────────┼───────────────────┘            │
│                               │                                │
│  ┌─────────────────────────────┼─────────────────────────────┐  │
│  │                    KeyBy (userId)                        │  │
│  │                                                           │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │              Hash-based Partitioning               │  │  │
│  │  │  user1 → Task 1  |  user2 → Task 2  |  user3 → Task 3  │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────┘  │
│                               │                                │
│  ┌─────────────────────────────┼─────────────────────────────┐  │
│  │              Process Function (Keyed State)              │  │
│  │                                                           │  │
│  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐  │  │
│  │  │   Task 1    │    │   Task 2    │    │   Task 3    │  │  │
│  │  │ (user1)     │    │ (user2)     │    │ (user3)     │  │  │
│  │  │             │    │             │    │             │  │  │
│  │  │ • ValueState │    │ • ValueState │    │ • ValueState │  │  │
│  │  │   (count)   │    │   (count)   │    │   (count)   │  │  │
│  │  │ • 3회 이상    │    │ • 3회 이상    │    │ • 3회 이상    │  │  │
│  │  │   시 알람     │    │   시 알람     │    │   시 알람     │  │  │
│  │  └─────────────┘    └─────────────┘    └─────────────┘  │  │
│  └───────────────────────────────────────────────────────────┘  │
│                               │                                │
│  ┌─────────────────────────────┼─────────────────────────────┐  │
│  │                        Sink                              │  │
│  │                                                           │  │
│  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐  │  │
│  │  │   Task 1    │    │   Task 2    │    │   Task 3    │  │  │
│  │  │ (로그 출력)  │    │ (로그 출력)  │    │ (로그 출력)  │  │  │
│  │  │             │    │             │    │             │  │  │
│  │  │ • 알람 메시지 │    │ • 알람 메시지 │    │ • 알람 메시지 │  │  │
│  │  │ • 처리 로그   │    │ • 처리 로그   │    │ • 처리 로그   │  │  │
│  │  └─────────────┘    └─────────────┘    └─────────────┘  │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

## 3. 체크포인트 동작 과정 다이어그램

```
┌─────────────────────────────────────────────────────────────────┐
│                    체크포인트 동작 과정                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐                                           │
│  │   JobManager    │                                           │
│  │ (Checkpoint     │                                           │
│  │  Coordinator)   │                                           │
│  └─────────────────┘                                           │
│           │                                                     │
│           │ 1. Checkpoint Barrier 전송                          │
│           ▼                                                     │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │              Barrier Alignment (정렬)                      │ │
│  │                                                             │ │
│  │  Source Task 1: [Event1] [Event2] [Barrier] [Event3]      │ │
│  │  Source Task 2: [Event1] [Barrier] [Event2] [Event3]      │ │
│  │  Source Task 3: [Event1] [Event2] [Event3] [Barrier]      │ │
│  │                                                             │ │
│  │  모든 Task가 Barrier를 받을 때까지 대기                        │ │
│  └─────────────────────────────────────────────────────────────┘ │
│           │                                                     │
│           │ 2. 상태 스냅샷 생성                                  │
│           ▼                                                     │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    상태 스냅샷                              │ │
│  │                                                             │ │
│  │  {                                                          │ │
│  │    "user1": {"abnormalCount": 2},                          │ │
│  │    "user2": {"abnormalCount": 0},                          │ │
│  │    "user3": {"abnormalCount": 1}                           │ │
│  │  }                                                          │ │
│  └─────────────────────────────────────────────────────────────┘ │
│           │                                                     │
│           │ 3. 외부 저장소에 저장                                │
│           ▼                                                     │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │              외부 저장소 (/tmp/flink-checkpoints)          │ │
│  │                                                             │ │
│  │  /tmp/flink-checkpoints/                                   │ │
│  │  └── {job-id}/                                             │ │
│  │      └── chk-{checkpoint-id}/                              │ │
│  │          └── _metadata (바이너리 상태 데이터)                │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## 4. 장애 복구 과정 다이어그램

```
┌─────────────────────────────────────────────────────────────────┐
│                    장애 복구 과정                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐                                           │
│  │   정상 상태      │                                           │
│  │                 │                                           │
│  │  TaskManager 1  │  TaskManager 2  │  TaskManager 3          │
│  │  [정상]         │  [정상]         │  [정상]                 │
│  └─────────────────┘                                           │
│           │                                                     │
│           │ 장애 발생!                                           │
│           ▼                                                     │
│  ┌─────────────────┐                                           │
│  │   장애 상태      │                                           │
│  │                 │                                           │
│  │  TaskManager 1  │  TaskManager 2  │  TaskManager 3          │
│  │  [정상]         │  [장애]         │  [정상]                 │
│  └─────────────────┘                                           │
│           │                                                     │
│           │ JobManager 장애 감지                                 │
│           ▼                                                     │
│  ┌─────────────────┐                                           │
│  │   복구 시작      │                                           │
│  │                 │                                           │
│  │  1. 최신 체크포인트 ID 확인                                   │
│  │  2. 모든 TaskManager에 복구 명령 전송                        │
│  │  3. 체크포인트 파일에서 상태 복원                             │
│  └─────────────────┘                                           │
│           │                                                     │
│           │ 복구 완료                                            │
│           ▼                                                     │
│  ┌─────────────────┐                                           │
│  │   복구된 상태    │                                           │
│  │                 │                                           │
│  │  TaskManager 1  │  TaskManager 2  │  TaskManager 3          │
│  │  [복구됨]       │  [새로 시작]    │  [복구됨]               │
│  │                 │  (체크포인트     │                         │
│  │                 │   상태 복원)     │                         │
│  └─────────────────┘                                           │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │              복구 후 처리 재개                              │ │
│  │                                                             │ │
│  │  • Source Task: 체크포인트 이후 데이터부터 재처리              │ │
│  │  • Process Function: 복원된 상태로 처리 재개                 │ │
│  │  • Sink Task: 정상 로그 출력 재개                           │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## 5. 모니터링 대시보드 구성

```
┌─────────────────────────────────────────────────────────────────┐
│                    실시간 모니터링 대시보드                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   클러스터 개요  │  │ TaskManager 정보 │  │   체크포인트    │ │
│  │                 │  │                 │  │     상태        │ │
│  │ • TaskManager: 3│  │ • TaskManager: 3│  │ • 총 체크포인트: │ │
│  │ • 총 슬롯: 9    │  │ • 총 슬롯: 9    │  │   165개         │ │
│  │ • 사용 가능: 0  │  │ • 사용 중: 9    │  │ • 완료: 165개   │ │
│  │ • 실행 중 Job: 1│  │ • 사용률: 100%  │  │ • 실패: 0개     │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    실행 중인 Job 목록                      │ │
│  │                                                             │ │
│  │  Job ID: f0159022d030626a6eeae31a9df47e3f                 │ │
│  │  이름: Internal Keyed State Abnormal Count Example         │ │
│  │  상태: RUNNING                                              │ │
│  │  시작 시간: 2024-07-11 11:56:00                            │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                  실시간 태스크 상태                         │ │
│  │                                                             │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │ │
│  │  │ Source Task │  │ Process     │  │ Sink Task   │        │ │
│  │  │ • 상태: 활성 │  │ Task        │  │ • 상태: 활성 │        │ │
│  │  │ • 처리량:    │  │ • 상태: 활성 │  │ • 처리량:    │        │ │
│  │  │   1,234     │  │ • 처리량:    │  │   567       │        │ │
│  │  │ • 체크포인트 │  │   1,234     │  │ • 체크포인트 │        │ │
│  │  │    크기: 6KB │  │ • 체크포인트 │  │    크기: 2KB │        │ │
│  │  └─────────────┘  │    크기: 6KB │  └─────────────┘        │ │
│  │                   └─────────────┘                          │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                  실시간 애플리케이션 로그                   │ │
│  │                                                             │ │
│  │  [11:58:15] [Source Emit] UserEvent{userId='user1',       │ │
│  │              isAbnormal=true}                              │ │
│  │  [11:58:15] [ALERT] userId=user1 이상행동 3회 감지!        │ │
│  │  [11:58:20] [Source Emit] UserEvent{userId='user2',       │ │
│  │              isAbnormal=false}                             │ │
│  │  [11:58:25] [Source Emit] UserEvent{userId='user3',       │ │
│  │              isAbnormal=true}                              │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                  체크포인트 히스토리                       │ │
│  │                                                             │ │
│  │  체크포인트 #217 - COMPLETED (8ms) - 6KB                   │ │
│  │  체크포인트 #216 - COMPLETED (5ms) - 6KB                   │ │
│  │  체크포인트 #215 - COMPLETED (3ms) - 6KB                   │ │
│  │  체크포인트 #214 - COMPLETED (12ms) - 6KB                  │ │
│  │  체크포인트 #213 - COMPLETED (5ms) - 6KB                   │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## 6. 발표용 코드 하이라이트

### 핵심 코드 스니펫

```java
// 1. 체크포인트 설정
env.enableCheckpointing(10000L, CheckpointingMode.EXACTLY_ONCE);
env.setStateBackend(new HashMapStateBackend());
env.getCheckpointConfig().setCheckpointStorage("file:///tmp/flink-checkpoints");

// 2. Source Function
public class RandomUserEventSource extends RichParallelSourceFunction<UserEvent> {
    // 3개의 병렬 Task로 분산 처리
    // 5초마다 랜덤 이벤트 생성
}

// 3. Keyed Process Function
public class AbnormalCountProcessFunction extends KeyedProcessFunction<String, UserEvent, String> {
    private ValueState<Integer> abnormalCountState; // 유저별 상태 저장
    
    // 유저 ID로 키 지정하여 분산 처리
    // 각 유저별로 독립적인 상태 관리
}

// 4. 상태 관리
ValueStateDescriptor<Integer> descriptor = new ValueStateDescriptor<>(
    "abnormalCount", Integer.class, 0);
abnormalCountState = getRuntimeContext().getState(descriptor);
```

### 발표 시 강조 포인트

1. **클러스터 아키텍처**: JobManager와 TaskManager의 역할 분담
2. **병렬 처리**: 3개의 병렬 Task로 분산 처리
3. **상태 관리**: Keyed State를 통한 유저별 독립적인 상태 관리
4. **체크포인트**: 장애 복구를 위한 상태 스냅샷 메커니즘
5. **실시간 모니터링**: 클러스터 상태와 체크포인트 추적 