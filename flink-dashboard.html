<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flink 클러스터 모니터링 대시보드</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .card h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        .metric {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .metric-value {
            font-weight: bold;
            color: #667eea;
        }
        .job-list {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .job-item {
            border: 1px solid #ddd;
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
            background-color: #f8f9fa;
        }
        .status-running {
            color: #28a745;
            font-weight: bold;
        }
        .status-finished {
            color: #6c757d;
        }
        .status-failed {
            color: #dc3545;
            font-weight: bold;
        }
        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 20px;
        }
        .refresh-btn:hover {
            background: #5a6fd8;
        }
        .error {
            color: #dc3545;
            background-color: #f8d7da;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .checkpoint-item {
            border: 1px solid #ddd;
            margin: 8px 0;
            padding: 12px;
            border-radius: 5px;
            background-color: #f8f9fa;
            font-size: 14px;
        }
        .checkpoint-completed {
            border-left: 4px solid #28a745;
        }
        .checkpoint-failed {
            border-left: 4px solid #dc3545;
        }
        .checkpoint-in-progress {
            border-left: 4px solid #ffc107;
        }
        .checkpoint-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 8px;
        }
        .detail-item {
            background-color: white;
            padding: 8px;
            border-radius: 3px;
            font-size: 12px;
        }
        .detail-label {
            font-weight: bold;
            color: #666;
        }
        .detail-value {
            color: #333;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 5px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.3s ease;
        }
        .log-container {
            background: #1e1e1e;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
        }
        .log-source {
            color: #66d9ef;
        }
        .log-process {
            color: #a6e22e;
        }
        .log-alert {
            color: #f92672;
            font-weight: bold;
        }
        .log-normal {
            color: #f8f8f2;
        }
        .log-timestamp {
            color: #75715e;
        }
        .task-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .task-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
        }
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .task-name {
            font-weight: bold;
            color: #495057;
        }
        .task-status-indicator {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        .status-active {
            background-color: #d4edda;
            color: #155724;
        }
        .status-idle {
            background-color: #fff3cd;
            color: #856404;
        }
        .task-metrics {
            font-size: 12px;
            color: #6c757d;
        }
        .metric-row {
            display: flex;
            justify-content: space-between;
            margin: 3px 0;
        }
        .live-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #28a745;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .control-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .control-btn:hover {
            background: #5a6268;
        }
        .control-btn.active {
            background: #28a745;
        }
        .control-btn.danger {
            background: #dc3545;
        }
        .control-btn.danger:hover {
            background: #c82333;
        }
        .diagram-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .diagram-title {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: bold;
        }
        .cluster-diagram {
            width: 100%;
            height: 400px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }
        .pipeline-diagram {
            width: 100%;
            height: 350px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }
        .node {
            position: absolute;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }
        .node:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }
        .jobmanager {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            width: 120px;
            height: 60px;
            font-size: 12px;
        }
        .taskmanager {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            width: 100px;
            height: 50px;
            font-size: 11px;
        }
        .slot {
            background: linear-gradient(45deg, #a8e6cf, #88d8c0);
            width: 80px;
            height: 40px;
            font-size: 10px;
            border: 2px solid #fff;
        }
        .source-task {
            background: linear-gradient(45deg, #ffd93d, #ff6b6b);
            width: 70px;
            height: 35px;
            font-size: 9px;
        }
        .process-task {
            background: linear-gradient(45deg, #6c5ce7, #a29bfe);
            width: 70px;
            height: 35px;
            font-size: 9px;
        }
        .sink-task {
            background: linear-gradient(45deg, #fd79a8, #fdcb6e);
            width: 70px;
            height: 35px;
            font-size: 9px;
        }
        .connection {
            position: absolute;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 2px;
        }
        .connection.vertical {
            width: 3px;
        }
        .connection.horizontal {
            height: 3px;
        }
        .data-flow {
            position: absolute;
            background: linear-gradient(90deg, #ffd93d, #ff6b6b, #6c5ce7, #fd79a8);
            height: 4px;
            border-radius: 2px;
            animation: flow 3s infinite linear;
        }
        @keyframes flow {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        .diagram-tabs {
            display: flex;
            margin-bottom: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 5px;
        }
        .diagram-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            background: transparent;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            color: #666;
            transition: all 0.3s ease;
        }
        .diagram-tab.active {
            background: #667eea;
            color: white;
        }
        .diagram-content {
            display: none;
        }
        .diagram-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 Flink 클러스터 모니터링 대시보드</h1>
            <p>실시간 클러스터 상태, Job 모니터링 및 로그 추적</p>
        </div>

        <div class="controls">
            <button class="refresh-btn" onclick="refreshData()">🔄 새로고침</button>
            <button class="control-btn" id="logToggle" onclick="toggleLogMonitoring()">📊 로그 모니터링</button>
            <button class="control-btn" id="checkpointToggle" onclick="toggleCheckpointMonitoring()">💾 체크포인트 모니터링</button>
            <button class="control-btn" onclick="clearLogs()">🗑️ 로그 지우기</button>
        </div>

        <div class="dashboard">
            <div class="card">
                <h3>📊 클러스터 개요</h3>
                <div id="overview">
                    <div class="metric">
                        <span>TaskManager 수:</span>
                        <span class="metric-value" id="taskmanagers">-</span>
                    </div>
                    <div class="metric">
                        <span>총 슬롯:</span>
                        <span class="metric-value" id="slots-total">-</span>
                    </div>
                    <div class="metric">
                        <span>사용 가능한 슬롯:</span>
                        <span class="metric-value" id="slots-available">-</span>
                    </div>
                    <div class="metric">
                        <span>실행 중인 Job:</span>
                        <span class="metric-value" id="jobs-running">-</span>
                    </div>
                    <div class="metric">
                        <span>완료된 Job:</span>
                        <span class="metric-value" id="jobs-finished">-</span>
                    </div>
                    <div class="metric">
                        <span>실패한 Job:</span>
                        <span class="metric-value" id="jobs-failed">-</span>
                    </div>
                    <div class="metric">
                        <span>Flink 버전:</span>
                        <span class="metric-value" id="flink-version">-</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>⚙️ TaskManager 정보</h3>
                <div id="taskmanager-info">
                    <div class="metric">
                        <span>TaskManager 수:</span>
                        <span class="metric-value" id="tm-count">-</span>
                    </div>
                    <div class="metric">
                        <span>총 슬롯:</span>
                        <span class="metric-value" id="tm-slots">-</span>
                    </div>
                    <div class="metric">
                        <span>사용 중인 슬롯:</span>
                        <span class="metric-value" id="tm-used-slots">-</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>💾 체크포인트 상태</h3>
                <div id="checkpoint-info">
                    <div class="metric">
                        <span>총 체크포인트:</span>
                        <span class="metric-value" id="total-checkpoints">-</span>
                    </div>
                    <div class="metric">
                        <span>완료된 체크포인트:</span>
                        <span class="metric-value" id="completed-checkpoints">-</span>
                    </div>
                    <div class="metric">
                        <span>실패한 체크포인트:</span>
                        <span class="metric-value" id="failed-checkpoints">-</span>
                    </div>
                    <div class="metric">
                        <span>진행 중인 체크포인트:</span>
                        <span class="metric-value" id="in-progress-checkpoints">-</span>
                    </div>
                    <div class="metric">
                        <span>복원된 체크포인트:</span>
                        <span class="metric-value" id="restored-checkpoints">-</span>
                    </div>
                    <div class="metric">
                        <span>평균 체크포인트 크기:</span>
                        <span class="metric-value" id="avg-checkpoint-size">-</span>
                    </div>
                    <div class="metric">
                        <span>평균 체크포인트 시간:</span>
                        <span class="metric-value" id="avg-checkpoint-duration">-</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="job-list">
            <h3>📋 실행 중인 Job 목록</h3>
            <div id="jobs-list">
                <p>데이터를 불러오는 중...</p>
            </div>
        </div>

        <div class="job-list">
            <h3>🔧 실시간 태스크 상태</h3>
            <div id="task-status">
                <p>태스크 정보를 불러오는 중...</p>
            </div>
        </div>

        <div class="job-list">
            <h3>📝 실시간 애플리케이션 로그</h3>
            <div class="log-container" id="log-container">
                <div class="log-entry">
                    <span class="log-timestamp">[시스템]</span>
                    <span class="log-normal">로그 모니터링이 시작되었습니다...</span>
                </div>
            </div>
        </div>

        <div class="job-list">
            <h3>💾 체크포인트 히스토리</h3>
            <div id="checkpoint-history">
                <p>체크포인트 데이터를 불러오는 중...</p>
            </div>
        </div>

        <div class="diagram-container">
            <div class="diagram-tabs">
                <button class="diagram-tab active" onclick="showDiagram('cluster')">🏗️ 클러스터 아키텍처</button>
                <button class="diagram-tab" onclick="showDiagram('pipeline')">🔄 스트림 처리 파이프라인</button>
            </div>
            
            <div id="cluster-diagram" class="diagram-content active">
                <div class="diagram-title">Flink 클러스터 아키텍처</div>
                <div class="cluster-diagram" id="cluster-svg">
                    <!-- JobManager -->
                    <div class="node jobmanager pulse" style="top: 20px; left: 50%; transform: translateX(-50%);">
                        JobManager<br>마스터 노드
                    </div>
                    
                    <!-- Connections from JobManager -->
                    <div class="connection vertical" style="top: 80px; left: 50%; height: 40px; transform: translateX(-50%);"></div>
                    
                    <!-- TaskManager 1 -->
                    <div class="node taskmanager" style="top: 130px; left: 20%;">
                        TaskManager 1<br>워커 노드
                    </div>
                    
                    <!-- TaskManager 2 -->
                    <div class="node taskmanager" style="top: 130px; left: 50%; transform: translateX(-50%);">
                        TaskManager 2<br>워커 노드
                    </div>
                    
                    <!-- TaskManager 3 -->
                    <div class="node taskmanager" style="top: 130px; left: 80%;">
                        TaskManager 3<br>워커 노드
                    </div>
                    
                    <!-- Slots for TaskManager 1 -->
                    <div class="node slot" style="top: 200px; left: 10%;">
                        Slot 1<br>Source
                    </div>
                    <div class="node slot" style="top: 200px; left: 20%;">
                        Slot 2<br>Process
                    </div>
                    <div class="node slot" style="top: 200px; left: 30%;">
                        Slot 3<br>Sink
                    </div>
                    
                    <!-- Slots for TaskManager 2 -->
                    <div class="node slot" style="top: 200px; left: 40%;">
                        Slot 4<br>Source
                    </div>
                    <div class="node slot" style="top: 200px; left: 50%;">
                        Slot 5<br>Process
                    </div>
                    <div class="node slot" style="top: 200px; left: 60%;">
                        Slot 6<br>Sink
                    </div>
                    
                    <!-- Slots for TaskManager 3 -->
                    <div class="node slot" style="top: 200px; left: 70%;">
                        Slot 7<br>Source
                    </div>
                    <div class="node slot" style="top: 200px; left: 80%;">
                        Slot 8<br>Process
                    </div>
                    <div class="node slot" style="top: 200px; left: 90%;">
                        Slot 9<br>Sink
                    </div>
                    
                    <!-- Tasks in Slots -->
                    <div class="node source-task" style="top: 260px; left: 10%;">
                        Source<br>user1
                    </div>
                    <div class="node process-task" style="top: 260px; left: 20%;">
                        Process<br>user1
                    </div>
                    <div class="node sink-task" style="top: 260px; left: 30%;">
                        Sink<br>로그
                    </div>
                    
                    <div class="node source-task" style="top: 260px; left: 40%;">
                        Source<br>user2
                    </div>
                    <div class="node process-task" style="top: 260px; left: 50%;">
                        Process<br>user2
                    </div>
                    <div class="node sink-task" style="top: 260px; left: 60%;">
                        Sink<br>로그
                    </div>
                    
                    <div class="node source-task" style="top: 260px; left: 70%;">
                        Source<br>user3
                    </div>
                    <div class="node process-task" style="top: 260px; left: 80%;">
                        Process<br>user3
                    </div>
                    <div class="node sink-task" style="top: 260px; left: 90%;">
                        Sink<br>로그
                    </div>
                    
                    <!-- Data Flow Animation -->
                    <div class="data-flow" style="top: 310px; left: 10%; width: 80%;"></div>
                </div>
            </div>
            
            <div id="pipeline-diagram" class="diagram-content">
                <div class="diagram-title">실시간 스트림 처리 파이프라인</div>
                <div class="pipeline-diagram" id="pipeline-svg">
                    <!-- Source Layer -->
                    <div class="node source-task pulse" style="top: 20px; left: 10%;">
                        Source<br>user1
                    </div>
                    <div class="node source-task pulse" style="top: 20px; left: 50%; transform: translateX(-50%);">
                        Source<br>user2
                    </div>
                    <div class="node source-task pulse" style="top: 20px; left: 90%;">
                        Source<br>user3
                    </div>
                    
                    <!-- Data Flow from Source -->
                    <div class="data-flow" style="top: 70px; left: 10%; width: 80%;"></div>
                    
                    <!-- KeyBy Layer -->
                    <div class="node" style="top: 90px; left: 50%; transform: translateX(-50%); background: linear-gradient(45deg, #74b9ff, #0984e3); width: 120px; height: 40px; font-size: 11px;">
                        KeyBy (userId)<br>Hash Partitioning
                    </div>
                    
                    <!-- Data Flow to Process -->
                    <div class="data-flow" style="top: 140px; left: 10%; width: 80%;"></div>
                    
                    <!-- Process Layer -->
                    <div class="node process-task" style="top: 160px; left: 10%;">
                        Process<br>user1
                    </div>
                    <div class="node process-task" style="top: 160px; left: 50%; transform: translateX(-50%);">
                        Process<br>user2
                    </div>
                    <div class="node process-task" style="top: 160px; left: 90%;">
                        Process<br>user3
                    </div>
                    
                    <!-- State Management -->
                    <div class="node" style="top: 200px; left: 10%; background: linear-gradient(45deg, #fd79a8, #e84393); width: 70px; height: 30px; font-size: 8px;">
                        ValueState<br>count: 2
                    </div>
                    <div class="node" style="top: 200px; left: 50%; transform: translateX(-50%); background: linear-gradient(45deg, #fd79a8, #e84393); width: 70px; height: 30px; font-size: 8px;">
                        ValueState<br>count: 0
                    </div>
                    <div class="node" style="top: 200px; left: 90%; background: linear-gradient(45deg, #fd79a8, #e84393); width: 70px; height: 30px; font-size: 8px;">
                        ValueState<br>count: 1
                    </div>
                    
                    <!-- Data Flow to Sink -->
                    <div class="data-flow" style="top: 250px; left: 10%; width: 80%;"></div>
                    
                    <!-- Sink Layer -->
                    <div class="node sink-task" style="top: 270px; left: 10%;">
                        Sink<br>로그 출력
                    </div>
                    <div class="node sink-task" style="top: 270px; left: 50%; transform: translateX(-50%);">
                        Sink<br>로그 출력
                    </div>
                    <div class="node sink-task" style="top: 270px; left: 90%;">
                        Sink<br>로그 출력
                    </div>
                    
                    <!-- Alert Animation -->
                    <div class="node" style="top: 310px; left: 50%; transform: translateX(-50%); background: linear-gradient(45deg, #ff7675, #d63031); width: 100px; height: 30px; font-size: 10px; animation: pulse 1s infinite;">
                        🚨 ALERT 발생!
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const FLINK_API_BASE = 'http://localhost:8081';
        let currentJobId = null;
        let logMonitoring = false;
        let checkpointMonitoring = true; // 기본적으로 체크포인트 모니터링 활성화
        let logEntries = [];
        let taskStatusData = {};

        // 시뮬레이션된 로그 데이터 (실제로는 Flink REST API에서 가져와야 함)
        const simulatedLogs = [
            { timestamp: Date.now(), type: 'source', message: '[Source Open] Subtask: 0', level: 'info' },
            { timestamp: Date.now(), type: 'source', message: '[Source Open] Subtask: 1', level: 'info' },
            { timestamp: Date.now(), type: 'source', message: '[Source Open] Subtask: 2', level: 'info' },
            { timestamp: Date.now(), type: 'source', message: '[Source Emit] UserEvent{userId=\'user1\', isAbnormal=true}', level: 'info' },
            { timestamp: Date.now(), type: 'process', message: '[ALERT] userId=user1 이상행동 1회 감지! (알람 전송)', level: 'alert' },
            { timestamp: Date.now(), type: 'source', message: '[Source Emit] UserEvent{userId=\'user2\', isAbnormal=false}', level: 'info' },
            { timestamp: Date.now(), type: 'checkpoint', message: 'Checkpoint #81 completed in 8ms', level: 'info' },
            { timestamp: Date.now(), type: 'source', message: '[Source Emit] UserEvent{userId=\'user3\', isAbnormal=true}', level: 'info' },
            { timestamp: Date.now(), type: 'process', message: '[ALERT] userId=user3 이상행동 1회 감지! (알람 전송)', level: 'alert' },
            { timestamp: Date.now(), type: 'checkpoint', message: 'State updated for user3: abnormalCount=1', level: 'info' }
        ];

        async function fetchData(endpoint) {
            try {
                const response = await fetch(`${FLINK_API_BASE}${endpoint}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Error fetching data:', error);
                throw error;
            }
        }

        function updateOverview(data) {
            document.getElementById('taskmanagers').textContent = data.taskmanagers || 0;
            document.getElementById('slots-total').textContent = data['slots-total'] || 0;
            document.getElementById('slots-available').textContent = data['slots-available'] || 0;
            document.getElementById('jobs-running').textContent = data['jobs-running'] || 0;
            document.getElementById('jobs-finished').textContent = data['jobs-finished'] || 0;
            document.getElementById('jobs-failed').textContent = data['jobs-failed'] || 0;
            document.getElementById('flink-version').textContent = data['flink-version'] || 'N/A';
        }

        function updateTaskManagerInfo(data) {
            if (data.taskmanagers && data.taskmanagers.length > 0) {
                const tm = data.taskmanagers[0];
                document.getElementById('tm-count').textContent = data.taskmanagers.length;
                document.getElementById('tm-slots').textContent = tm['slotsNumber'] || 0;
                document.getElementById('tm-used-slots').textContent = tm['freeSlots'] || 0;
            }
        }

        function updateCheckpointInfo(data) {
            console.log('Updating checkpoint info with data:', data);
            
            const counts = data.counts || {};
            const summary = data.summary || {};
            
            document.getElementById('total-checkpoints').textContent = counts.total || 0;
            document.getElementById('completed-checkpoints').textContent = counts.completed || 0;
            document.getElementById('failed-checkpoints').textContent = counts.failed || 0;
            document.getElementById('in-progress-checkpoints').textContent = counts.in_progress || 0;
            document.getElementById('restored-checkpoints').textContent = counts.restored || 0;
            
            // 평균 체크포인트 크기 (KB)
            const avgSize = summary.checkpointed_size ? Math.round(summary.checkpointed_size.avg / 1024 * 100) / 100 : 0;
            document.getElementById('avg-checkpoint-size').textContent = `${avgSize} KB`;
            
            // 평균 체크포인트 시간 (ms)
            const avgDuration = summary.end_to_end_duration ? Math.round(summary.end_to_end_duration.avg) : 0;
            document.getElementById('avg-checkpoint-duration').textContent = `${avgDuration} ms`;
        }

        function updateJobsList(jobs) {
            const jobsContainer = document.getElementById('jobs-list');
            
            if (!jobs || jobs.length === 0) {
                jobsContainer.innerHTML = '<p>실행 중인 Job이 없습니다.</p>';
                currentJobId = null;
                return;
            }

            const jobsHtml = jobs.map(job => {
                const statusClass = job.status === 'RUNNING' ? 'status-running' : 
                                  job.status === 'FINISHED' ? 'status-finished' : 'status-failed';
                
                return `
                    <div class="job-item">
                        <h4>Job ID: ${job.id}</h4>
                        <p><strong>이름:</strong> ${job.name || 'N/A'}</p>
                        <p><strong>상태:</strong> <span class="${statusClass}">${job.status}</span></p>
                        <p><strong>시작 시간:</strong> ${job['start-time'] ? new Date(job['start-time']).toLocaleString() : 'N/A'}</p>
                        <p><strong>종료 시간:</strong> ${job['end-time'] ? new Date(job['end-time']).toLocaleString() : 'N/A'}</p>
                        <p><strong>지속 시간:</strong> ${job.duration || 'N/A'}ms</p>
                    </div>
                `;
            }).join('');

            jobsContainer.innerHTML = jobsHtml;
            
            // 첫 번째 실행 중인 Job의 ID를 저장
            const runningJob = jobs.find(job => job.status === 'RUNNING');
            if (runningJob) {
                currentJobId = runningJob.id;
                console.log('Current Job ID:', currentJobId);
            } else {
                currentJobId = null;
            }
        }

        function updateTaskStatus() {
            const taskStatusContainer = document.getElementById('task-status');
            
            // 시뮬레이션된 태스크 데이터
            const tasks = [
                {
                    name: 'RandomUserEventSource',
                    status: 'active',
                    subtasks: 3,
                    activeSubtasks: 3,
                    processedRecords: Math.floor(Math.random() * 1000) + 500,
                    checkpointedSize: Math.floor(Math.random() * 10) + 5
                },
                {
                    name: 'AbnormalCountProcessFunction',
                    status: 'active',
                    subtasks: 3,
                    activeSubtasks: 3,
                    processedRecords: Math.floor(Math.random() * 1000) + 500,
                    checkpointedSize: Math.floor(Math.random() * 10) + 5
                },
                {
                    name: 'Print Sink',
                    status: 'active',
                    subtasks: 1,
                    activeSubtasks: 1,
                    processedRecords: Math.floor(Math.random() * 100) + 50,
                    checkpointedSize: Math.floor(Math.random() * 5) + 2
                }
            ];

            const tasksHtml = tasks.map(task => `
                <div class="task-card">
                    <div class="task-header">
                        <span class="task-name">${task.name}</span>
                        <span class="task-status-indicator status-${task.status}">
                            ${task.status === 'active' ? '<span class="live-indicator"></span>활성' : '대기'}
                        </span>
                    </div>
                    <div class="task-metrics">
                        <div class="metric-row">
                            <span>서브태스크:</span>
                            <span>${task.activeSubtasks}/${task.subtasks}</span>
                        </div>
                        <div class="metric-row">
                            <span>처리된 레코드:</span>
                            <span>${task.processedRecords.toLocaleString()}</span>
                        </div>
                        <div class="metric-row">
                            <span>체크포인트 크기:</span>
                            <span>${task.checkpointedSize} KB</span>
                        </div>
                    </div>
                </div>
            `).join('');

            taskStatusContainer.innerHTML = tasksHtml;
        }

        function addLogEntry(log) {
            const logContainer = document.getElementById('log-container');
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            const timestamp = new Date(log.timestamp).toLocaleTimeString();
            const logClass = log.type === 'alert' ? 'log-alert' : 
                           log.type === 'source' ? 'log-source' : 
                           log.type === 'process' ? 'log-process' : 'log-normal';
            
            logEntry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                <span class="${logClass}">${log.message}</span>
            `;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // 최대 100개 로그 항목만 유지
            if (logContainer.children.length > 100) {
                logContainer.removeChild(logContainer.firstChild);
            }
        }

        function updateCheckpointHistory(data) {
            console.log('Updating checkpoint history with data:', data);
            
            const historyContainer = document.getElementById('checkpoint-history');
            
            if (!data.history || data.history.length === 0) {
                historyContainer.innerHTML = '<p>체크포인트 히스토리가 없습니다.</p>';
                return;
            }

            // 최근 10개의 체크포인트만 표시
            const recentCheckpoints = data.history.slice(0, 10);
            
            const checkpointsHtml = recentCheckpoints.map(checkpoint => {
                const statusClass = checkpoint.status === 'COMPLETED' ? 'checkpoint-completed' : 
                                  checkpoint.status === 'FAILED' ? 'checkpoint-failed' : 'checkpoint-in-progress';
                
                const checkpointSize = Math.round((checkpoint.checkpointed_size || 0) / 1024 * 100) / 100;
                const duration = checkpoint.end_to_end_duration || 0;
                const timestamp = checkpoint.trigger_timestamp ? new Date(checkpoint.trigger_timestamp).toLocaleString() : 'N/A';
                
                return `
                    <div class="checkpoint-item ${statusClass}">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <strong>체크포인트 #${checkpoint.id}</strong>
                            <span style="color: ${checkpoint.status === 'COMPLETED' ? '#28a745' : checkpoint.status === 'FAILED' ? '#dc3545' : '#ffc107'}">
                                ${checkpoint.status}
                            </span>
                        </div>
                        <div class="checkpoint-details">
                            <div class="detail-item">
                                <div class="detail-label">트리거 시간:</div>
                                <div class="detail-value">${timestamp}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">크기:</div>
                                <div class="detail-value">${checkpointSize} KB</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">소요 시간:</div>
                                <div class="detail-value">${duration} ms</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">서브태스크:</div>
                                <div class="detail-value">${checkpoint.num_acknowledged_subtasks || 0}/${checkpoint.num_subtasks || 0}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">저장 경로:</div>
                                <div class="detail-value" style="font-size: 11px; word-break: break-all;">${checkpoint.external_path || 'N/A'}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            historyContainer.innerHTML = checkpointsHtml;
        }

        function toggleLogMonitoring() {
            logMonitoring = !logMonitoring;
            const btn = document.getElementById('logToggle');
            btn.classList.toggle('active');
            btn.textContent = logMonitoring ? '📊 로그 모니터링 중지' : '📊 로그 모니터링';
        }

        function toggleCheckpointMonitoring() {
            checkpointMonitoring = !checkpointMonitoring;
            const btn = document.getElementById('checkpointToggle');
            btn.classList.toggle('active');
            btn.textContent = checkpointMonitoring ? '💾 체크포인트 모니터링 중지' : '💾 체크포인트 모니터링';
        }

        function clearLogs() {
            const logContainer = document.getElementById('log-container');
            logContainer.innerHTML = `
                <div class="log-entry">
                    <span class="log-timestamp">[시스템]</span>
                    <span class="log-normal">로그가 지워졌습니다.</span>
                </div>
            `;
        }

        function showDiagram(type) {
            // 모든 탭 비활성화
            document.querySelectorAll('.diagram-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.diagram-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // 선택된 탭 활성화
            if (type === 'cluster') {
                document.querySelector('.diagram-tab:first-child').classList.add('active');
                document.getElementById('cluster-diagram').classList.add('active');
            } else if (type === 'pipeline') {
                document.querySelector('.diagram-tab:last-child').classList.add('active');
                document.getElementById('pipeline-diagram').classList.add('active');
            }
        }

        function simulateLogs() {
            if (logMonitoring) {
                const randomLog = simulatedLogs[Math.floor(Math.random() * simulatedLogs.length)];
                const newLog = {
                    ...randomLog,
                    timestamp: Date.now(),
                    message: randomLog.message.replace(/user\d+/, `user${Math.floor(Math.random() * 3) + 1}`)
                };
                addLogEntry(newLog);
            }
        }

        async function refreshData() {
            try {
                // 클러스터 개요 가져오기
                const overview = await fetchData('/overview');
                updateOverview(overview);

                // TaskManager 정보 가져오기
                const taskmanagers = await fetchData('/taskmanagers');
                updateTaskManagerInfo(taskmanagers);

                // Job 목록 가져오기
                const jobs = await fetchData('/jobs');
                updateJobsList(jobs.jobs || []);

                // 태스크 상태 업데이트
                updateTaskStatus();

                // 체크포인트 정보 가져오기 (실행 중인 Job이 있는 경우)
                if (currentJobId && checkpointMonitoring) {
                    try {
                        console.log('Fetching checkpoint data for job:', currentJobId);
                        const checkpointData = await fetchData(`/jobs/${currentJobId}/checkpoints`);
                        console.log('Checkpoint data received:', checkpointData);
                        updateCheckpointInfo(checkpointData);
                        updateCheckpointHistory(checkpointData);
                    } catch (error) {
                        console.error('Error fetching checkpoint data:', error);
                        document.getElementById('checkpoint-info').innerHTML = `
                            <div class="error">
                                <strong>체크포인트 정보 오류:</strong> ${error.message}
                            </div>
                        `;
                        document.getElementById('checkpoint-history').innerHTML = `
                            <div class="error">
                                <strong>체크포인트 히스토리 오류:</strong> ${error.message}
                            </div>
                        `;
                    }
                } else if (!checkpointMonitoring) {
                    document.getElementById('checkpoint-info').innerHTML = '<p>체크포인트 모니터링이 비활성화되었습니다.</p>';
                    document.getElementById('checkpoint-history').innerHTML = '<p>체크포인트 모니터링이 비활성화되었습니다.</p>';
                } else {
                    document.getElementById('checkpoint-info').innerHTML = '<p>실행 중인 Job이 없습니다.</p>';
                    document.getElementById('checkpoint-history').innerHTML = '<p>실행 중인 Job이 없습니다.</p>';
                }

            } catch (error) {
                console.error('Error refreshing data:', error);
                document.getElementById('jobs-list').innerHTML = `
                    <div class="error">
                        <strong>오류:</strong> Flink API에 연결할 수 없습니다. 
                        Flink 클러스터가 실행 중인지 확인해주세요.
                    </div>
                `;
            }
        }

        // 페이지 로드 시 데이터 가져오기
        refreshData();

        // 체크포인트 모니터링 버튼 초기 상태 설정
        document.getElementById('checkpointToggle').classList.add('active');
        document.getElementById('checkpointToggle').textContent = '💾 체크포인트 모니터링 중지';

        // 10초마다 자동 새로고침
        setInterval(refreshData, 10000);

        // 3초마다 로그 시뮬레이션
        setInterval(simulateLogs, 3000);
    </script>
</body>
</html> 