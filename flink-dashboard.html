<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flink í´ëŸ¬ìŠ¤í„° ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .card h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        .metric {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .metric-value {
            font-weight: bold;
            color: #667eea;
        }
        .job-list {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .job-item {
            border: 1px solid #ddd;
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
            background-color: #f8f9fa;
        }
        .status-running {
            color: #28a745;
            font-weight: bold;
        }
        .status-finished {
            color: #6c757d;
        }
        .status-failed {
            color: #dc3545;
            font-weight: bold;
        }
        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 20px;
        }
        .refresh-btn:hover {
            background: #5a6fd8;
        }
        .error {
            color: #dc3545;
            background-color: #f8d7da;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .checkpoint-item {
            border: 1px solid #ddd;
            margin: 8px 0;
            padding: 12px;
            border-radius: 5px;
            background-color: #f8f9fa;
            font-size: 14px;
        }
        .checkpoint-completed {
            border-left: 4px solid #28a745;
        }
        .checkpoint-failed {
            border-left: 4px solid #dc3545;
        }
        .checkpoint-in-progress {
            border-left: 4px solid #ffc107;
        }
        .checkpoint-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 8px;
        }
        .detail-item {
            background-color: white;
            padding: 8px;
            border-radius: 3px;
            font-size: 12px;
        }
        .detail-label {
            font-weight: bold;
            color: #666;
        }
        .detail-value {
            color: #333;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 5px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.3s ease;
        }
        .log-container {
            background: #1e1e1e;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
        }
        .log-source {
            color: #66d9ef;
        }
        .log-process {
            color: #a6e22e;
        }
        .log-alert {
            color: #f92672;
            font-weight: bold;
        }
        .log-normal {
            color: #f8f8f2;
        }
        .log-timestamp {
            color: #75715e;
        }
        .task-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .task-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
        }
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .task-name {
            font-weight: bold;
            color: #495057;
        }
        .task-status-indicator {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        .status-active {
            background-color: #d4edda;
            color: #155724;
        }
        .status-idle {
            background-color: #fff3cd;
            color: #856404;
        }
        .task-metrics {
            font-size: 12px;
            color: #6c757d;
        }
        .metric-row {
            display: flex;
            justify-content: space-between;
            margin: 3px 0;
        }
        .live-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #28a745;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .control-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .control-btn:hover {
            background: #5a6268;
        }
        .control-btn.active {
            background: #28a745;
        }
        .control-btn.danger {
            background: #dc3545;
        }
        .control-btn.danger:hover {
            background: #c82333;
        }
        .diagram-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .diagram-title {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: bold;
        }
        .cluster-diagram {
            width: 100%;
            height: 400px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }
        .pipeline-diagram {
            width: 100%;
            height: 350px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }
        .node {
            position: absolute;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }
        .node:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }
        .jobmanager {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            width: 120px;
            height: 60px;
            font-size: 12px;
        }
        .taskmanager {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            width: 100px;
            height: 50px;
            font-size: 11px;
        }
        .slot {
            background: linear-gradient(45deg, #a8e6cf, #88d8c0);
            width: 80px;
            height: 40px;
            font-size: 10px;
            border: 2px solid #fff;
        }
        .source-task {
            background: linear-gradient(45deg, #ffd93d, #ff6b6b);
            width: 70px;
            height: 35px;
            font-size: 9px;
        }
        .process-task {
            background: linear-gradient(45deg, #6c5ce7, #a29bfe);
            width: 70px;
            height: 35px;
            font-size: 9px;
        }
        .sink-task {
            background: linear-gradient(45deg, #fd79a8, #fdcb6e);
            width: 70px;
            height: 35px;
            font-size: 9px;
        }
        .connection {
            position: absolute;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 2px;
        }
        .connection.vertical {
            width: 3px;
        }
        .connection.horizontal {
            height: 3px;
        }
        .data-flow {
            position: absolute;
            background: linear-gradient(90deg, #ffd93d, #ff6b6b, #6c5ce7, #fd79a8);
            height: 4px;
            border-radius: 2px;
            animation: flow 3s infinite linear;
        }
        @keyframes flow {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        .diagram-tabs {
            display: flex;
            margin-bottom: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 5px;
        }
        .diagram-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            background: transparent;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            color: #666;
            transition: all 0.3s ease;
        }
        .diagram-tab.active {
            background: #667eea;
            color: white;
        }
        .diagram-content {
            display: none;
        }
        .diagram-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ Flink í´ëŸ¬ìŠ¤í„° ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ</h1>
            <p>ì‹¤ì‹œê°„ í´ëŸ¬ìŠ¤í„° ìƒíƒœ, Job ëª¨ë‹ˆí„°ë§ ë° ë¡œê·¸ ì¶”ì </p>
        </div>

        <div class="controls">
            <button class="refresh-btn" onclick="refreshData()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            <button class="control-btn" id="logToggle" onclick="toggleLogMonitoring()">ğŸ“Š ë¡œê·¸ ëª¨ë‹ˆí„°ë§</button>
            <button class="control-btn" id="checkpointToggle" onclick="toggleCheckpointMonitoring()">ğŸ’¾ ì²´í¬í¬ì¸íŠ¸ ëª¨ë‹ˆí„°ë§</button>
            <button class="control-btn" onclick="clearLogs()">ğŸ—‘ï¸ ë¡œê·¸ ì§€ìš°ê¸°</button>
        </div>

        <div class="dashboard">
            <div class="card">
                <h3>ğŸ“Š í´ëŸ¬ìŠ¤í„° ê°œìš”</h3>
                <div id="overview">
                    <div class="metric">
                        <span>TaskManager ìˆ˜:</span>
                        <span class="metric-value" id="taskmanagers">-</span>
                    </div>
                    <div class="metric">
                        <span>ì´ ìŠ¬ë¡¯:</span>
                        <span class="metric-value" id="slots-total">-</span>
                    </div>
                    <div class="metric">
                        <span>ì‚¬ìš© ê°€ëŠ¥í•œ ìŠ¬ë¡¯:</span>
                        <span class="metric-value" id="slots-available">-</span>
                    </div>
                    <div class="metric">
                        <span>ì‹¤í–‰ ì¤‘ì¸ Job:</span>
                        <span class="metric-value" id="jobs-running">-</span>
                    </div>
                    <div class="metric">
                        <span>ì™„ë£Œëœ Job:</span>
                        <span class="metric-value" id="jobs-finished">-</span>
                    </div>
                    <div class="metric">
                        <span>ì‹¤íŒ¨í•œ Job:</span>
                        <span class="metric-value" id="jobs-failed">-</span>
                    </div>
                    <div class="metric">
                        <span>Flink ë²„ì „:</span>
                        <span class="metric-value" id="flink-version">-</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>âš™ï¸ TaskManager ì •ë³´</h3>
                <div id="taskmanager-info">
                    <div class="metric">
                        <span>TaskManager ìˆ˜:</span>
                        <span class="metric-value" id="tm-count">-</span>
                    </div>
                    <div class="metric">
                        <span>ì´ ìŠ¬ë¡¯:</span>
                        <span class="metric-value" id="tm-slots">-</span>
                    </div>
                    <div class="metric">
                        <span>ì‚¬ìš© ì¤‘ì¸ ìŠ¬ë¡¯:</span>
                        <span class="metric-value" id="tm-used-slots">-</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>ğŸ’¾ ì²´í¬í¬ì¸íŠ¸ ìƒíƒœ</h3>
                <div id="checkpoint-info">
                    <div class="metric">
                        <span>ì´ ì²´í¬í¬ì¸íŠ¸:</span>
                        <span class="metric-value" id="total-checkpoints">-</span>
                    </div>
                    <div class="metric">
                        <span>ì™„ë£Œëœ ì²´í¬í¬ì¸íŠ¸:</span>
                        <span class="metric-value" id="completed-checkpoints">-</span>
                    </div>
                    <div class="metric">
                        <span>ì‹¤íŒ¨í•œ ì²´í¬í¬ì¸íŠ¸:</span>
                        <span class="metric-value" id="failed-checkpoints">-</span>
                    </div>
                    <div class="metric">
                        <span>ì§„í–‰ ì¤‘ì¸ ì²´í¬í¬ì¸íŠ¸:</span>
                        <span class="metric-value" id="in-progress-checkpoints">-</span>
                    </div>
                    <div class="metric">
                        <span>ë³µì›ëœ ì²´í¬í¬ì¸íŠ¸:</span>
                        <span class="metric-value" id="restored-checkpoints">-</span>
                    </div>
                    <div class="metric">
                        <span>í‰ê·  ì²´í¬í¬ì¸íŠ¸ í¬ê¸°:</span>
                        <span class="metric-value" id="avg-checkpoint-size">-</span>
                    </div>
                    <div class="metric">
                        <span>í‰ê·  ì²´í¬í¬ì¸íŠ¸ ì‹œê°„:</span>
                        <span class="metric-value" id="avg-checkpoint-duration">-</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="job-list">
            <h3>ğŸ“‹ ì‹¤í–‰ ì¤‘ì¸ Job ëª©ë¡</h3>
            <div id="jobs-list">
                <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
        </div>

        <div class="job-list">
            <h3>ğŸ”§ ì‹¤ì‹œê°„ íƒœìŠ¤í¬ ìƒíƒœ</h3>
            <div id="task-status">
                <p>íƒœìŠ¤í¬ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
        </div>

        <div class="job-list">
            <h3>ğŸ“ ì‹¤ì‹œê°„ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸</h3>
            <div class="log-container" id="log-container">
                <div class="log-entry">
                    <span class="log-timestamp">[ì‹œìŠ¤í…œ]</span>
                    <span class="log-normal">ë¡œê·¸ ëª¨ë‹ˆí„°ë§ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤...</span>
                </div>
            </div>
        </div>

        <div class="job-list">
            <h3>ğŸ’¾ ì²´í¬í¬ì¸íŠ¸ íˆìŠ¤í† ë¦¬</h3>
            <div id="checkpoint-history">
                <p>ì²´í¬í¬ì¸íŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
        </div>

        <div class="diagram-container">
            <div class="diagram-tabs">
                <button class="diagram-tab active" onclick="showDiagram('cluster')">ğŸ—ï¸ í´ëŸ¬ìŠ¤í„° ì•„í‚¤í…ì²˜</button>
                <button class="diagram-tab" onclick="showDiagram('pipeline')">ğŸ”„ ìŠ¤íŠ¸ë¦¼ ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸</button>
            </div>
            
            <div id="cluster-diagram" class="diagram-content active">
                <div class="diagram-title">Flink í´ëŸ¬ìŠ¤í„° ì•„í‚¤í…ì²˜</div>
                <div class="cluster-diagram" id="cluster-svg">
                    <!-- JobManager -->
                    <div class="node jobmanager pulse" style="top: 20px; left: 50%; transform: translateX(-50%);">
                        JobManager<br>ë§ˆìŠ¤í„° ë…¸ë“œ
                    </div>
                    
                    <!-- Connections from JobManager -->
                    <div class="connection vertical" style="top: 80px; left: 50%; height: 40px; transform: translateX(-50%);"></div>
                    
                    <!-- TaskManager 1 -->
                    <div class="node taskmanager" style="top: 130px; left: 20%;">
                        TaskManager 1<br>ì›Œì»¤ ë…¸ë“œ
                    </div>
                    
                    <!-- TaskManager 2 -->
                    <div class="node taskmanager" style="top: 130px; left: 50%; transform: translateX(-50%);">
                        TaskManager 2<br>ì›Œì»¤ ë…¸ë“œ
                    </div>
                    
                    <!-- TaskManager 3 -->
                    <div class="node taskmanager" style="top: 130px; left: 80%;">
                        TaskManager 3<br>ì›Œì»¤ ë…¸ë“œ
                    </div>
                    
                    <!-- Slots for TaskManager 1 -->
                    <div class="node slot" style="top: 200px; left: 10%;">
                        Slot 1<br>Source
                    </div>
                    <div class="node slot" style="top: 200px; left: 20%;">
                        Slot 2<br>Process
                    </div>
                    <div class="node slot" style="top: 200px; left: 30%;">
                        Slot 3<br>Sink
                    </div>
                    
                    <!-- Slots for TaskManager 2 -->
                    <div class="node slot" style="top: 200px; left: 40%;">
                        Slot 4<br>Source
                    </div>
                    <div class="node slot" style="top: 200px; left: 50%;">
                        Slot 5<br>Process
                    </div>
                    <div class="node slot" style="top: 200px; left: 60%;">
                        Slot 6<br>Sink
                    </div>
                    
                    <!-- Slots for TaskManager 3 -->
                    <div class="node slot" style="top: 200px; left: 70%;">
                        Slot 7<br>Source
                    </div>
                    <div class="node slot" style="top: 200px; left: 80%;">
                        Slot 8<br>Process
                    </div>
                    <div class="node slot" style="top: 200px; left: 90%;">
                        Slot 9<br>Sink
                    </div>
                    
                    <!-- Tasks in Slots -->
                    <div class="node source-task" style="top: 260px; left: 10%;">
                        Source<br>user1
                    </div>
                    <div class="node process-task" style="top: 260px; left: 20%;">
                        Process<br>user1
                    </div>
                    <div class="node sink-task" style="top: 260px; left: 30%;">
                        Sink<br>ë¡œê·¸
                    </div>
                    
                    <div class="node source-task" style="top: 260px; left: 40%;">
                        Source<br>user2
                    </div>
                    <div class="node process-task" style="top: 260px; left: 50%;">
                        Process<br>user2
                    </div>
                    <div class="node sink-task" style="top: 260px; left: 60%;">
                        Sink<br>ë¡œê·¸
                    </div>
                    
                    <div class="node source-task" style="top: 260px; left: 70%;">
                        Source<br>user3
                    </div>
                    <div class="node process-task" style="top: 260px; left: 80%;">
                        Process<br>user3
                    </div>
                    <div class="node sink-task" style="top: 260px; left: 90%;">
                        Sink<br>ë¡œê·¸
                    </div>
                    
                    <!-- Data Flow Animation -->
                    <div class="data-flow" style="top: 310px; left: 10%; width: 80%;"></div>
                </div>
            </div>
            
            <div id="pipeline-diagram" class="diagram-content">
                <div class="diagram-title">ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¼ ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸</div>
                <div class="pipeline-diagram" id="pipeline-svg">
                    <!-- Source Layer -->
                    <div class="node source-task pulse" style="top: 20px; left: 10%;">
                        Source<br>user1
                    </div>
                    <div class="node source-task pulse" style="top: 20px; left: 50%; transform: translateX(-50%);">
                        Source<br>user2
                    </div>
                    <div class="node source-task pulse" style="top: 20px; left: 90%;">
                        Source<br>user3
                    </div>
                    
                    <!-- Data Flow from Source -->
                    <div class="data-flow" style="top: 70px; left: 10%; width: 80%;"></div>
                    
                    <!-- KeyBy Layer -->
                    <div class="node" style="top: 90px; left: 50%; transform: translateX(-50%); background: linear-gradient(45deg, #74b9ff, #0984e3); width: 120px; height: 40px; font-size: 11px;">
                        KeyBy (userId)<br>Hash Partitioning
                    </div>
                    
                    <!-- Data Flow to Process -->
                    <div class="data-flow" style="top: 140px; left: 10%; width: 80%;"></div>
                    
                    <!-- Process Layer -->
                    <div class="node process-task" style="top: 160px; left: 10%;">
                        Process<br>user1
                    </div>
                    <div class="node process-task" style="top: 160px; left: 50%; transform: translateX(-50%);">
                        Process<br>user2
                    </div>
                    <div class="node process-task" style="top: 160px; left: 90%;">
                        Process<br>user3
                    </div>
                    
                    <!-- State Management -->
                    <div class="node" style="top: 200px; left: 10%; background: linear-gradient(45deg, #fd79a8, #e84393); width: 70px; height: 30px; font-size: 8px;">
                        ValueState<br>count: 2
                    </div>
                    <div class="node" style="top: 200px; left: 50%; transform: translateX(-50%); background: linear-gradient(45deg, #fd79a8, #e84393); width: 70px; height: 30px; font-size: 8px;">
                        ValueState<br>count: 0
                    </div>
                    <div class="node" style="top: 200px; left: 90%; background: linear-gradient(45deg, #fd79a8, #e84393); width: 70px; height: 30px; font-size: 8px;">
                        ValueState<br>count: 1
                    </div>
                    
                    <!-- Data Flow to Sink -->
                    <div class="data-flow" style="top: 250px; left: 10%; width: 80%;"></div>
                    
                    <!-- Sink Layer -->
                    <div class="node sink-task" style="top: 270px; left: 10%;">
                        Sink<br>ë¡œê·¸ ì¶œë ¥
                    </div>
                    <div class="node sink-task" style="top: 270px; left: 50%; transform: translateX(-50%);">
                        Sink<br>ë¡œê·¸ ì¶œë ¥
                    </div>
                    <div class="node sink-task" style="top: 270px; left: 90%;">
                        Sink<br>ë¡œê·¸ ì¶œë ¥
                    </div>
                    
                    <!-- Alert Animation -->
                    <div class="node" style="top: 310px; left: 50%; transform: translateX(-50%); background: linear-gradient(45deg, #ff7675, #d63031); width: 100px; height: 30px; font-size: 10px; animation: pulse 1s infinite;">
                        ğŸš¨ ALERT ë°œìƒ!
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const FLINK_API_BASE = 'http://localhost:8081';
        let currentJobId = null;
        let logMonitoring = false;
        let checkpointMonitoring = true; // ê¸°ë³¸ì ìœ¼ë¡œ ì²´í¬í¬ì¸íŠ¸ ëª¨ë‹ˆí„°ë§ í™œì„±í™”
        let logEntries = [];
        let taskStatusData = {};

        // ì‹œë®¬ë ˆì´ì…˜ëœ ë¡œê·¸ ë°ì´í„° (ì‹¤ì œë¡œëŠ” Flink REST APIì—ì„œ ê°€ì ¸ì™€ì•¼ í•¨)
        const simulatedLogs = [
            { timestamp: Date.now(), type: 'source', message: '[Source Open] Subtask: 0', level: 'info' },
            { timestamp: Date.now(), type: 'source', message: '[Source Open] Subtask: 1', level: 'info' },
            { timestamp: Date.now(), type: 'source', message: '[Source Open] Subtask: 2', level: 'info' },
            { timestamp: Date.now(), type: 'source', message: '[Source Emit] UserEvent{userId=\'user1\', isAbnormal=true}', level: 'info' },
            { timestamp: Date.now(), type: 'process', message: '[ALERT] userId=user1 ì´ìƒí–‰ë™ 1íšŒ ê°ì§€! (ì•ŒëŒ ì „ì†¡)', level: 'alert' },
            { timestamp: Date.now(), type: 'source', message: '[Source Emit] UserEvent{userId=\'user2\', isAbnormal=false}', level: 'info' },
            { timestamp: Date.now(), type: 'checkpoint', message: 'Checkpoint #81 completed in 8ms', level: 'info' },
            { timestamp: Date.now(), type: 'source', message: '[Source Emit] UserEvent{userId=\'user3\', isAbnormal=true}', level: 'info' },
            { timestamp: Date.now(), type: 'process', message: '[ALERT] userId=user3 ì´ìƒí–‰ë™ 1íšŒ ê°ì§€! (ì•ŒëŒ ì „ì†¡)', level: 'alert' },
            { timestamp: Date.now(), type: 'checkpoint', message: 'State updated for user3: abnormalCount=1', level: 'info' }
        ];

        async function fetchData(endpoint) {
            try {
                const response = await fetch(`${FLINK_API_BASE}${endpoint}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Error fetching data:', error);
                throw error;
            }
        }

        function updateOverview(data) {
            document.getElementById('taskmanagers').textContent = data.taskmanagers || 0;
            document.getElementById('slots-total').textContent = data['slots-total'] || 0;
            document.getElementById('slots-available').textContent = data['slots-available'] || 0;
            document.getElementById('jobs-running').textContent = data['jobs-running'] || 0;
            document.getElementById('jobs-finished').textContent = data['jobs-finished'] || 0;
            document.getElementById('jobs-failed').textContent = data['jobs-failed'] || 0;
            document.getElementById('flink-version').textContent = data['flink-version'] || 'N/A';
        }

        function updateTaskManagerInfo(data) {
            if (data.taskmanagers && data.taskmanagers.length > 0) {
                const tm = data.taskmanagers[0];
                document.getElementById('tm-count').textContent = data.taskmanagers.length;
                document.getElementById('tm-slots').textContent = tm['slotsNumber'] || 0;
                document.getElementById('tm-used-slots').textContent = tm['freeSlots'] || 0;
            }
        }

        function updateCheckpointInfo(data) {
            console.log('Updating checkpoint info with data:', data);
            
            const counts = data.counts || {};
            const summary = data.summary || {};
            
            document.getElementById('total-checkpoints').textContent = counts.total || 0;
            document.getElementById('completed-checkpoints').textContent = counts.completed || 0;
            document.getElementById('failed-checkpoints').textContent = counts.failed || 0;
            document.getElementById('in-progress-checkpoints').textContent = counts.in_progress || 0;
            document.getElementById('restored-checkpoints').textContent = counts.restored || 0;
            
            // í‰ê·  ì²´í¬í¬ì¸íŠ¸ í¬ê¸° (KB)
            const avgSize = summary.checkpointed_size ? Math.round(summary.checkpointed_size.avg / 1024 * 100) / 100 : 0;
            document.getElementById('avg-checkpoint-size').textContent = `${avgSize} KB`;
            
            // í‰ê·  ì²´í¬í¬ì¸íŠ¸ ì‹œê°„ (ms)
            const avgDuration = summary.end_to_end_duration ? Math.round(summary.end_to_end_duration.avg) : 0;
            document.getElementById('avg-checkpoint-duration').textContent = `${avgDuration} ms`;
        }

        function updateJobsList(jobs) {
            const jobsContainer = document.getElementById('jobs-list');
            
            if (!jobs || jobs.length === 0) {
                jobsContainer.innerHTML = '<p>ì‹¤í–‰ ì¤‘ì¸ Jobì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                currentJobId = null;
                return;
            }

            const jobsHtml = jobs.map(job => {
                const statusClass = job.status === 'RUNNING' ? 'status-running' : 
                                  job.status === 'FINISHED' ? 'status-finished' : 'status-failed';
                
                return `
                    <div class="job-item">
                        <h4>Job ID: ${job.id}</h4>
                        <p><strong>ì´ë¦„:</strong> ${job.name || 'N/A'}</p>
                        <p><strong>ìƒíƒœ:</strong> <span class="${statusClass}">${job.status}</span></p>
                        <p><strong>ì‹œì‘ ì‹œê°„:</strong> ${job['start-time'] ? new Date(job['start-time']).toLocaleString() : 'N/A'}</p>
                        <p><strong>ì¢…ë£Œ ì‹œê°„:</strong> ${job['end-time'] ? new Date(job['end-time']).toLocaleString() : 'N/A'}</p>
                        <p><strong>ì§€ì† ì‹œê°„:</strong> ${job.duration || 'N/A'}ms</p>
                    </div>
                `;
            }).join('');

            jobsContainer.innerHTML = jobsHtml;
            
            // ì²« ë²ˆì§¸ ì‹¤í–‰ ì¤‘ì¸ Jobì˜ IDë¥¼ ì €ì¥
            const runningJob = jobs.find(job => job.status === 'RUNNING');
            if (runningJob) {
                currentJobId = runningJob.id;
                console.log('Current Job ID:', currentJobId);
            } else {
                currentJobId = null;
            }
        }

        function updateTaskStatus() {
            const taskStatusContainer = document.getElementById('task-status');
            
            // ì‹œë®¬ë ˆì´ì…˜ëœ íƒœìŠ¤í¬ ë°ì´í„°
            const tasks = [
                {
                    name: 'RandomUserEventSource',
                    status: 'active',
                    subtasks: 3,
                    activeSubtasks: 3,
                    processedRecords: Math.floor(Math.random() * 1000) + 500,
                    checkpointedSize: Math.floor(Math.random() * 10) + 5
                },
                {
                    name: 'AbnormalCountProcessFunction',
                    status: 'active',
                    subtasks: 3,
                    activeSubtasks: 3,
                    processedRecords: Math.floor(Math.random() * 1000) + 500,
                    checkpointedSize: Math.floor(Math.random() * 10) + 5
                },
                {
                    name: 'Print Sink',
                    status: 'active',
                    subtasks: 1,
                    activeSubtasks: 1,
                    processedRecords: Math.floor(Math.random() * 100) + 50,
                    checkpointedSize: Math.floor(Math.random() * 5) + 2
                }
            ];

            const tasksHtml = tasks.map(task => `
                <div class="task-card">
                    <div class="task-header">
                        <span class="task-name">${task.name}</span>
                        <span class="task-status-indicator status-${task.status}">
                            ${task.status === 'active' ? '<span class="live-indicator"></span>í™œì„±' : 'ëŒ€ê¸°'}
                        </span>
                    </div>
                    <div class="task-metrics">
                        <div class="metric-row">
                            <span>ì„œë¸ŒíƒœìŠ¤í¬:</span>
                            <span>${task.activeSubtasks}/${task.subtasks}</span>
                        </div>
                        <div class="metric-row">
                            <span>ì²˜ë¦¬ëœ ë ˆì½”ë“œ:</span>
                            <span>${task.processedRecords.toLocaleString()}</span>
                        </div>
                        <div class="metric-row">
                            <span>ì²´í¬í¬ì¸íŠ¸ í¬ê¸°:</span>
                            <span>${task.checkpointedSize} KB</span>
                        </div>
                    </div>
                </div>
            `).join('');

            taskStatusContainer.innerHTML = tasksHtml;
        }

        function addLogEntry(log) {
            const logContainer = document.getElementById('log-container');
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            const timestamp = new Date(log.timestamp).toLocaleTimeString();
            const logClass = log.type === 'alert' ? 'log-alert' : 
                           log.type === 'source' ? 'log-source' : 
                           log.type === 'process' ? 'log-process' : 'log-normal';
            
            logEntry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                <span class="${logClass}">${log.message}</span>
            `;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // ìµœëŒ€ 100ê°œ ë¡œê·¸ í•­ëª©ë§Œ ìœ ì§€
            if (logContainer.children.length > 100) {
                logContainer.removeChild(logContainer.firstChild);
            }
        }

        function updateCheckpointHistory(data) {
            console.log('Updating checkpoint history with data:', data);
            
            const historyContainer = document.getElementById('checkpoint-history');
            
            if (!data.history || data.history.length === 0) {
                historyContainer.innerHTML = '<p>ì²´í¬í¬ì¸íŠ¸ íˆìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            // ìµœê·¼ 10ê°œì˜ ì²´í¬í¬ì¸íŠ¸ë§Œ í‘œì‹œ
            const recentCheckpoints = data.history.slice(0, 10);
            
            const checkpointsHtml = recentCheckpoints.map(checkpoint => {
                const statusClass = checkpoint.status === 'COMPLETED' ? 'checkpoint-completed' : 
                                  checkpoint.status === 'FAILED' ? 'checkpoint-failed' : 'checkpoint-in-progress';
                
                const checkpointSize = Math.round((checkpoint.checkpointed_size || 0) / 1024 * 100) / 100;
                const duration = checkpoint.end_to_end_duration || 0;
                const timestamp = checkpoint.trigger_timestamp ? new Date(checkpoint.trigger_timestamp).toLocaleString() : 'N/A';
                
                return `
                    <div class="checkpoint-item ${statusClass}">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <strong>ì²´í¬í¬ì¸íŠ¸ #${checkpoint.id}</strong>
                            <span style="color: ${checkpoint.status === 'COMPLETED' ? '#28a745' : checkpoint.status === 'FAILED' ? '#dc3545' : '#ffc107'}">
                                ${checkpoint.status}
                            </span>
                        </div>
                        <div class="checkpoint-details">
                            <div class="detail-item">
                                <div class="detail-label">íŠ¸ë¦¬ê±° ì‹œê°„:</div>
                                <div class="detail-value">${timestamp}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">í¬ê¸°:</div>
                                <div class="detail-value">${checkpointSize} KB</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">ì†Œìš” ì‹œê°„:</div>
                                <div class="detail-value">${duration} ms</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">ì„œë¸ŒíƒœìŠ¤í¬:</div>
                                <div class="detail-value">${checkpoint.num_acknowledged_subtasks || 0}/${checkpoint.num_subtasks || 0}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">ì €ì¥ ê²½ë¡œ:</div>
                                <div class="detail-value" style="font-size: 11px; word-break: break-all;">${checkpoint.external_path || 'N/A'}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            historyContainer.innerHTML = checkpointsHtml;
        }

        function toggleLogMonitoring() {
            logMonitoring = !logMonitoring;
            const btn = document.getElementById('logToggle');
            btn.classList.toggle('active');
            btn.textContent = logMonitoring ? 'ğŸ“Š ë¡œê·¸ ëª¨ë‹ˆí„°ë§ ì¤‘ì§€' : 'ğŸ“Š ë¡œê·¸ ëª¨ë‹ˆí„°ë§';
        }

        function toggleCheckpointMonitoring() {
            checkpointMonitoring = !checkpointMonitoring;
            const btn = document.getElementById('checkpointToggle');
            btn.classList.toggle('active');
            btn.textContent = checkpointMonitoring ? 'ğŸ’¾ ì²´í¬í¬ì¸íŠ¸ ëª¨ë‹ˆí„°ë§ ì¤‘ì§€' : 'ğŸ’¾ ì²´í¬í¬ì¸íŠ¸ ëª¨ë‹ˆí„°ë§';
        }

        function clearLogs() {
            const logContainer = document.getElementById('log-container');
            logContainer.innerHTML = `
                <div class="log-entry">
                    <span class="log-timestamp">[ì‹œìŠ¤í…œ]</span>
                    <span class="log-normal">ë¡œê·¸ê°€ ì§€ì›Œì¡ŒìŠµë‹ˆë‹¤.</span>
                </div>
            `;
        }

        function showDiagram(type) {
            // ëª¨ë“  íƒ­ ë¹„í™œì„±í™”
            document.querySelectorAll('.diagram-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.diagram-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // ì„ íƒëœ íƒ­ í™œì„±í™”
            if (type === 'cluster') {
                document.querySelector('.diagram-tab:first-child').classList.add('active');
                document.getElementById('cluster-diagram').classList.add('active');
            } else if (type === 'pipeline') {
                document.querySelector('.diagram-tab:last-child').classList.add('active');
                document.getElementById('pipeline-diagram').classList.add('active');
            }
        }

        function simulateLogs() {
            if (logMonitoring) {
                const randomLog = simulatedLogs[Math.floor(Math.random() * simulatedLogs.length)];
                const newLog = {
                    ...randomLog,
                    timestamp: Date.now(),
                    message: randomLog.message.replace(/user\d+/, `user${Math.floor(Math.random() * 3) + 1}`)
                };
                addLogEntry(newLog);
            }
        }

        async function refreshData() {
            try {
                // í´ëŸ¬ìŠ¤í„° ê°œìš” ê°€ì ¸ì˜¤ê¸°
                const overview = await fetchData('/overview');
                updateOverview(overview);

                // TaskManager ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const taskmanagers = await fetchData('/taskmanagers');
                updateTaskManagerInfo(taskmanagers);

                // Job ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                const jobs = await fetchData('/jobs');
                updateJobsList(jobs.jobs || []);

                // íƒœìŠ¤í¬ ìƒíƒœ ì—…ë°ì´íŠ¸
                updateTaskStatus();

                // ì²´í¬í¬ì¸íŠ¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ì‹¤í–‰ ì¤‘ì¸ Jobì´ ìˆëŠ” ê²½ìš°)
                if (currentJobId && checkpointMonitoring) {
                    try {
                        console.log('Fetching checkpoint data for job:', currentJobId);
                        const checkpointData = await fetchData(`/jobs/${currentJobId}/checkpoints`);
                        console.log('Checkpoint data received:', checkpointData);
                        updateCheckpointInfo(checkpointData);
                        updateCheckpointHistory(checkpointData);
                    } catch (error) {
                        console.error('Error fetching checkpoint data:', error);
                        document.getElementById('checkpoint-info').innerHTML = `
                            <div class="error">
                                <strong>ì²´í¬í¬ì¸íŠ¸ ì •ë³´ ì˜¤ë¥˜:</strong> ${error.message}
                            </div>
                        `;
                        document.getElementById('checkpoint-history').innerHTML = `
                            <div class="error">
                                <strong>ì²´í¬í¬ì¸íŠ¸ íˆìŠ¤í† ë¦¬ ì˜¤ë¥˜:</strong> ${error.message}
                            </div>
                        `;
                    }
                } else if (!checkpointMonitoring) {
                    document.getElementById('checkpoint-info').innerHTML = '<p>ì²´í¬í¬ì¸íŠ¸ ëª¨ë‹ˆí„°ë§ì´ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.</p>';
                    document.getElementById('checkpoint-history').innerHTML = '<p>ì²´í¬í¬ì¸íŠ¸ ëª¨ë‹ˆí„°ë§ì´ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.</p>';
                } else {
                    document.getElementById('checkpoint-info').innerHTML = '<p>ì‹¤í–‰ ì¤‘ì¸ Jobì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    document.getElementById('checkpoint-history').innerHTML = '<p>ì‹¤í–‰ ì¤‘ì¸ Jobì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                }

            } catch (error) {
                console.error('Error refreshing data:', error);
                document.getElementById('jobs-list').innerHTML = `
                    <div class="error">
                        <strong>ì˜¤ë¥˜:</strong> Flink APIì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. 
                        Flink í´ëŸ¬ìŠ¤í„°ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.
                    </div>
                `;
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        refreshData();

        // ì²´í¬í¬ì¸íŠ¸ ëª¨ë‹ˆí„°ë§ ë²„íŠ¼ ì´ˆê¸° ìƒíƒœ ì„¤ì •
        document.getElementById('checkpointToggle').classList.add('active');
        document.getElementById('checkpointToggle').textContent = 'ğŸ’¾ ì²´í¬í¬ì¸íŠ¸ ëª¨ë‹ˆí„°ë§ ì¤‘ì§€';

        // 10ì´ˆë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨
        setInterval(refreshData, 10000);

        // 3ì´ˆë§ˆë‹¤ ë¡œê·¸ ì‹œë®¬ë ˆì´ì…˜
        setInterval(simulateLogs, 3000);
    </script>
</body>
</html> 